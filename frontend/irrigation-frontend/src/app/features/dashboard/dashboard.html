<app-navbar></app-navbar>

<div class="min-h-screen bg-gray-50 py-6 px-4 sm:px-6 lg:px-8">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">Tableau de bord</h1>
          <p class="text-gray-600 mt-2">Vue d'ensemble du systÃ¨me d'irrigation intelligent</p>
          <p class="text-sm text-gray-500 mt-1">
            <span class="inline-flex items-center">
              <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
              DerniÃ¨re mise Ã  jour: {{ now | date:'HH:mm:ss' }}
            </span>
          </p>
        </div>
        <div class="mt-4 sm:mt-0 flex space-x-3">
          <button 
            (click)="refreshData()"
            class="inline-flex items-center px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium"
            [disabled]="isLoadingAny"
          >
            <svg class="w-5 h-5 mr-2" [class.animate-spin]="isLoadingAny" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            {{ isLoadingAny ? 'Actualisation...' : 'Actualiser' }}
          </button>
        </div>
      </div>
    </div>

    <!-- Alertes -->
    <div *ngIf="stats.alertes > 0" class="mb-6">
      <div class="bg-red-50 border border-red-200 rounded-xl p-4">
        <div class="flex items-center">
          <svg class="w-5 h-5 text-red-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
          </svg>
          <h3 class="text-lg font-semibold text-red-800">{{ stats.alertes }} alerte(s) dÃ©tectÃ©e(s)</h3>
        </div>
        
        <div class="mt-3 space-y-2">
          <div *ngFor="let alert of alerts" class="text-sm text-red-700">
            â€¢ {{ alert }}
          </div>
          <div *ngFor="let capteur of alertes.capteursInactifs" class="text-sm text-red-700">
            â€¢ Capteur {{ capteur.type }} (#{{ capteur.id }}) inactif
          </div>
        </div>
      </div>
    </div>

    <!-- Stats principales -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <!-- Parcelles -->
      <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500">
        <div class="flex items-center">
          <div class="bg-green-100 p-3 rounded-lg mr-4">
            <span class="text-2xl">ðŸŒ±</span>
          </div>
          <div>
            <p class="text-gray-500 text-sm">Parcelles actives</p>
            <p class="text-2xl font-bold">{{ stats.totalParcelles }}</p>
            <p class="text-sm text-gray-600 mt-1">{{ stats.surfaceTotale }} ha total</p>
          </div>
        </div>
        <div class="mt-4">
          <a routerLink="/parcelles" class="text-green-600 hover:text-green-800 text-sm font-medium flex items-center">
            GÃ©rer les parcelles
            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </a>
        </div>
      </div>

      <!-- Irrigation active -->
      <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500">
        <div class="flex items-center">
          <div class="bg-blue-100 p-3 rounded-lg mr-4">
            <span class="text-2xl">ðŸš°</span>
          </div>
          <div>
            <p class="text-gray-500 text-sm">Irrigation active</p>
            <p class="text-2xl font-bold">{{ stats.irrigationActive }}</p>
            <p class="text-sm text-gray-600 mt-1">{{ stats.irrigationToday }} aujourd'hui</p>
          </div>
        </div>
        <div class="mt-4">
          <a routerLink="/irrigation" class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center">
            Voir l'irrigation
            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </a>
        </div>
      </div>

      <!-- Capteurs -->
      <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-purple-500">
        <div class="flex items-center">
          <div class="bg-purple-100 p-3 rounded-lg mr-4">
            <span class="text-2xl">ðŸ“¡</span>
          </div>
          <div>
            <p class="text-gray-500 text-sm">Capteurs actifs</p>
            <p class="text-2xl font-bold">{{ stats.capteursActifs }}/{{ capteurs.length }}</p>
            <p class="text-sm text-gray-600 mt-1">{{ capteurs.length }} capteurs installÃ©s</p>
          </div>
        </div>
        <div class="mt-4">
          <a routerLink="/capteurs" class="text-purple-600 hover:text-purple-800 text-sm font-medium flex items-center">
            GÃ©rer les capteurs
            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </a>
        </div>
      </div>

      <!-- Consommation eau -->
      <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-cyan-500">
        <div class="flex items-center">
          <div class="bg-cyan-100 p-3 rounded-lg mr-4">
            <span class="text-2xl">ðŸ’§</span>
          </div>
          <div>
            <p class="text-gray-500 text-sm">Eau consommÃ©e</p>
            <p class="text-2xl font-bold">{{ stats.consommationEau | number:'1.0-0' }} L</p>
            <p class="text-sm text-gray-600 mt-1">{{ stats.avgHumidity | number:'1.1-1' }}% humiditÃ© moyenne</p>
          </div>
        </div>
        <div class="mt-4">
          <a routerLink="/mesures" class="text-cyan-600 hover:text-cyan-800 text-sm font-medium flex items-center">
            Voir les donnÃ©es
            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </a>
        </div>
      </div>
    </div>

    <!-- Contenu principal -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Colonne gauche : Parcelles et HumiditÃ© -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Ã‰tat des parcelles -->
        <div class="bg-white rounded-xl shadow-md p-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold text-gray-800">Ã‰tat des parcelles</h2>
            <div class="flex items-center space-x-2">
              <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                {{ parcelles.length }} parcelles
              </span>
              <a routerLink="/parcelles/create" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                + Ajouter
              </a>
            </div>
          </div>

          <div *ngIf="isLoading.parcelles" class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <p class="mt-2 text-gray-600">Chargement des parcelles...</p>
          </div>

          <div *ngIf="!isLoading.parcelles && parcelles.length === 0" class="text-center py-8">
            <span class="text-4xl mb-4 block">ðŸŒ±</span>
            <h3 class="text-lg font-medium text-gray-900">Aucune parcelle configurÃ©e</h3>
            <p class="text-gray-600 mt-1">Commencez par crÃ©er votre premiÃ¨re parcelle</p>
            <a routerLink="/parcelles/create" class="mt-4 inline-block text-blue-600 hover:text-blue-800 font-medium">
              CrÃ©er une parcelle â†’
            </a>
          </div>

          <div *ngIf="!isLoading.parcelles && parcelles.length > 0" class="space-y-4">
            <div *ngFor="let parcelle of parcelles.slice(0, 5)" 
                 class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
              <div class="flex justify-between items-center mb-3">
                <div>
                  <h3 class="font-semibold text-gray-800">{{ parcelle.nom }}</h3>
                  <p class="text-sm text-gray-500">{{ parcelle.superficie }} ha â€¢ Seuils: {{ parcelle.seuilHumiditeMin }}-{{ parcelle.seuilHumiditeMax }}%</p>
                </div>
                <div class="text-right">
                  <div *ngIf="mesuresCourantes[parcelle.id] as mesure">
                    <span class="text-lg font-bold" 
                          [class]="getHumiditeStatus(parcelle.id) === 'danger' ? 'text-red-600' :
                                   getHumiditeStatus(parcelle.id) === 'warning' ? 'text-yellow-600' : 'text-green-600'">
                      {{ mesure.valeur || 0 }}%
                    </span>
                    <p class="text-xs text-gray-500">
                      {{ formatTime(mesure.dateMesure) }}
                    </p>
                  </div>
                  <div *ngIf="!mesuresCourantes[parcelle.id]" class="text-gray-400 text-sm">
                    Aucune donnÃ©e
                  </div>
                </div>
              </div>

              <!-- Barre de progression d'humiditÃ© -->
              <div *ngIf="mesuresCourantes[parcelle.id]">
                <div class="mb-2 flex justify-between text-sm">
                  <span class="text-gray-600">HumiditÃ© du sol</span>
                  <span class="font-medium">{{ getHumiditePercent(parcelle.id) }}%</span>
                </div>
                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                  <div [class]="'h-full rounded-full transition-all duration-500 ' + getProgressColor(getHumiditePercent(parcelle.id))"
                       [style.width.%]="getHumiditePercent(parcelle.id)">
                  </div>
                </div>
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                  <span>Min: {{ parcelle.seuilHumiditeMin }}%</span>
                  <span>IdÃ©al: {{ (parcelle.seuilHumiditeMin + parcelle.seuilHumiditeMax) / 2 | number:'1.0-0' }}%</span>
                  <span>Max: {{ parcelle.seuilHumiditeMax }}%</span>
                </div>
              </div>

              <div class="mt-3 pt-3 border-t border-gray-100">
                <a [routerLink]="['/parcelles']" 
                   class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                  Voir les dÃ©tails â†’
                </a>
              </div>
            </div>
            
            <div *ngIf="parcelles.length > 5" class="text-center pt-4">
              <a routerLink="/parcelles" class="text-blue-600 hover:text-blue-800 font-medium">
                Voir toutes les {{ parcelles.length }} parcelles â†’
              </a>
            </div>
          </div>
        </div>

        <!-- Irrigations en cours -->
        <div class="bg-white rounded-xl shadow-md p-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold text-gray-800">Irrigations en cours</h2>
            <span [class]="'px-3 py-1 rounded-full text-sm font-medium ' + 
                          (stats.irrigationActive > 0 ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800')">
              {{ stats.irrigationActive }} active(s)
            </span>
          </div>

          <div *ngIf="isLoading.irrigations" class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <p class="mt-2 text-gray-600">Chargement des irrigations...</p>
          </div>

          <div *ngIf="!isLoading.irrigations && irrigationsEnCours.length === 0" class="text-center py-8 text-gray-500">
            <span class="text-4xl mb-2 block">ðŸ’§</span>
            <p>Aucune irrigation en cours</p>
            <p class="text-sm mt-1">Toutes les irrigations sont terminÃ©es ou planifiÃ©es</p>
          </div>

          <div *ngIf="!isLoading.irrigations && irrigationsEnCours.length > 0" class="space-y-4">
            <div *ngFor="let irrigation of irrigationsEnCours.slice(0, 3)" 
                 class="border border-green-100 bg-green-50 rounded-lg p-4">
              <div class="flex justify-between items-center">
                <div>
                  <h4 class="font-semibold text-gray-800">
                    Parcelle {{ getParcelleName(irrigation.parcelleId) || '#' + irrigation.parcelleId }}
                  </h4>
                  <p class="text-sm text-gray-600">
                    DÃ©but: {{ formatTime(irrigation.dateDebut) }} â€¢ 
                    DurÃ©e: {{ formatDuration(irrigation.duree) }}
                  </p>
                </div>
                <div class="text-right">
                  <span [class]="'px-3 py-1 rounded-full text-xs font-medium ' + getStatusColor(irrigation.statut)">
                    {{ irrigation.statut }}
                  </span>
                  <p class="text-sm text-gray-600 mt-1">
                    Volume: {{ irrigation.volumeEau }} L
                  </p>
                </div>
              </div>
              
              <!-- Progression -->
              <div class="mt-4">
                <div class="flex justify-between text-xs text-gray-600 mb-1">
                  <span>Progression</span>
                  <span>{{ getProgressPercentage(irrigation) }}%</span>
                </div>
                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                  <div class="h-full bg-green-500 transition-all duration-300"
                       [style.width.%]="getProgressPercentage(irrigation)">
                  </div>
                </div>
              </div>
            </div>
            
            <div *ngIf="irrigationsEnCours.length > 3" class="text-center pt-4">
              <a routerLink="/irrigation" class="text-green-600 hover:text-green-800 font-medium">
                Voir toutes les {{ irrigationsEnCours.length }} irrigations â†’
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- Colonne droite : Capteurs et Actions -->
      <div class="space-y-6">
        <!-- Ã‰tat des capteurs -->
        <div class="bg-white rounded-xl shadow-md p-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-6">Capteurs</h2>
          
          <div *ngIf="isLoading.capteurs" class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <p class="mt-2 text-gray-600">Chargement des capteurs...</p>
          </div>
          
          <div *ngIf="!isLoading.capteurs && capteurs.length === 0" class="text-center py-8">
            <span class="text-4xl mb-4 block">ðŸ“¡</span>
            <p class="text-gray-600">Aucun capteur installÃ©</p>
            <a routerLink="/capteurs/create" class="mt-2 inline-block text-blue-600 hover:text-blue-800 text-sm font-medium">
              Ajouter un capteur
            </a>
          </div>

          <div *ngIf="!isLoading.capteurs && capteurs.length > 0" class="space-y-4">
            <div *ngFor="let capteur of capteurs.slice(0, 5)" 
                 class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
              <div class="flex items-center">
                <span class="text-2xl mr-3">{{ getIconForTypeCapteur(capteur.type) }}</span>
                <div>
                  <p class="font-medium text-gray-800">{{ capteur.type }}</p>
                  <p class="text-sm text-gray-500">{{ capteur.localisation }}</p>
                </div>
              </div>
              <span [class]="'px-2 py-1 rounded text-xs font-medium ' + 
                          (capteur.etat === 'ACTIF' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800')">
                {{ capteur.etat }}
              </span>
            </div>
            
            <div *ngIf="capteurs.length > 5" class="text-center pt-2">
              <a routerLink="/capteurs" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                Voir tous les {{ capteurs.length }} capteurs â†’
              </a>
            </div>
          </div>
        </div>

        <!-- Actions rapides -->
        <div class="bg-white rounded-xl shadow-md p-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-6">Actions rapides</h2>
          
          <div class="grid grid-cols-2 gap-3">
            <a routerLink="/parcelles/create"
               class="flex flex-col items-center justify-center p-4 border border-blue-200 
                      rounded-lg hover:bg-blue-50 transition-colors group">
              <span class="text-2xl mb-2">ðŸŒ±</span>
              <span class="text-sm font-medium text-blue-700 group-hover:text-blue-900">
                Nouvelle parcelle
              </span>
            </a>
            
            <a routerLink="/capteurs/create"
               class="flex flex-col items-center justify-center p-4 border border-green-200 
                      rounded-lg hover:bg-green-50 transition-colors group">
              <span class="text-2xl mb-2">ðŸ“¡</span>
              <span class="text-sm font-medium text-green-700 group-hover:text-green-900">
                Nouveau capteur
              </span>
            </a>
            
            <a routerLink="/irrigation"
               class="flex flex-col items-center justify-center p-4 border border-yellow-200 
                      rounded-lg hover:bg-yellow-50 transition-colors group">
              <span class="text-2xl mb-2">ðŸš°</span>
              <span class="text-sm font-medium text-yellow-700 group-hover:text-yellow-900">
                DÃ©marrer irrigation
              </span>
            </a>
            
            <a routerLink="/mesures"
               class="flex flex-col items-center justify-center p-4 border border-purple-200 
                      rounded-lg hover:bg-purple-50 transition-colors group">
              <span class="text-2xl mb-2">ðŸ“Š</span>
              <span class="text-sm font-medium text-purple-700 group-hover:text-purple-900">
                Voir rapports
              </span>
            </a>
          </div>
        </div>

        <!-- DerniÃ¨res mesures -->
        <div class="bg-white rounded-xl shadow-md p-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-6">DerniÃ¨res mesures</h2>
          
          <div *ngIf="isLoading.mesures" class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
            <p class="mt-2 text-sm text-gray-600">Chargement...</p>
          </div>
          
          <div *ngIf="!isLoading.mesures && recentMesures.length === 0" class="text-center py-8 text-gray-500">
            <span class="text-2xl mb-2 block">ðŸ“ˆ</span>
            <p class="text-sm">Aucune mesure rÃ©cente</p>
          </div>
          
          <div *ngIf="!isLoading.mesures && recentMesures.length > 0" class="space-y-3">
            <div *ngFor="let item of recentMesures" 
                 class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
              <div class="flex items-center">
                <span class="text-xl mr-3">{{ getIconForTypeCapteur(item.capteur.type) }}</span>
                <div>
                  <p class="text-sm font-medium text-gray-800">{{ item.capteur.localisation }}</p>
                  <p class="text-xs text-gray-500">{{ formatTime(item.dateMesure) }}</p>
                </div>
              </div>
              <div class="text-right">
                <span class="font-bold">{{ item.valeur | number:'1.1-1' }}</span>
                <p class="text-xs text-gray-500">{{ item.unite }}</p>
              </div>
            </div>
            
            <div class="text-center pt-2">
              <a routerLink="/mesures" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                Voir toutes les mesures â†’
              </a>
            </div>
          </div>
        </div>

        <!-- AperÃ§u systÃ¨me -->
        <div class="bg-gradient-to-r from-blue-500 to-cyan-500 rounded-xl shadow-md p-6 text-white">
          <h2 class="text-xl font-semibold mb-4">SystÃ¨me d'irrigation</h2>
          <p class="text-blue-100 mb-4">
            Statut: 
            <span class="font-semibold text-white">
              {{ stats.alertes > 0 ? 'Surveillance' : 'OpÃ©rationnel' }}
            </span>
          </p>
          
          <div class="space-y-3">
            <div class="flex justify-between">
              <span>Parcelles irriguÃ©es</span>
              <span class="font-semibold">{{ irrigationsEnCours.length }}/{{ parcelles.length }}</span>
            </div>
            <div class="flex justify-between">
              <span>Capteurs connectÃ©s</span>
              <span class="font-semibold">{{ stats.capteursActifs }}/{{ capteurs.length }}</span>
            </div>
            <div class="flex justify-between">
              <span>HumiditÃ© moyenne</span>
              <span class="font-semibold">{{ stats.avgHumidity | number:'1.1-1' }}%</span>
            </div>
            <div class="flex justify-between">
              <span>DerniÃ¨re mise Ã  jour</span>
              <span class="font-semibold">{{ now | date:'HH:mm:ss' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>